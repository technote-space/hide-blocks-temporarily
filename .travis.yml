language: php

sudo: false
dist: trusty

git:
  depth: 3

notifications:
  email: false
  slack:
    secure: jX4BLfFjvEcLfSry+94JuTR+sLFDO4rXJC6GKVcL4FfdHFyvD/x8qQmRvTLymKIm6VRwWCvn4aEjTYUUjYyB26LJmPpgAXTvNQSL7pUM3SRuEnagUJD+WfLxO8fHe+UnZlD/69nKuaZ0ZEqgFjqsmkmeJtsDqLt5v/07ki5smxCArwtCbUK0mW5Thnk+DMKKe52s1d5j32NsCO/PK+AVosnt/FtkiRrS0Hln7OdT0YEgUT3TyOvf2jXN6XCvs51Wo7FqOJ220VovfN3fjdasikyZCRqhzd0H+fcOIBvjDRzPzvCRWTabGkJQQsneVID8P3e8pW18hIrFp1z8nu8edCkBfjWzoek2xA4NIoRyGyQ5iL/4ZSOpZzxH0K6l0sMhbH8Q3XMp4jAyc+DVpR+K1R4r4zvquvUL3AtZ2sRthTr28QYDeUdHTxulNkTAdH2WgqODhROWweX10+yssHqJ7J6dzJ+4c7WDw/tkatrnQRDUMdbKxXghhJahJyy6EIjM1fanjNbQ1R0/zOpa3ruADTzO6AEr31/UAYvi8TMui8i1mT+0mwiEF7duxICB+IseKZP0OOVreYYxSvomZKsV9xaqlHY/ats3ukFTjZC2OKFu76rCENAoU/kj1gEXzpqv0DiycniXVvFlQHIG4ZmU008CLR1QvlHF26e6UhC86kc=

branches:
  only:
    - master
    - "/^v[0-9\\.]+/"

cache:
  yarn: true
  directories:
    - "${HOME}/.composer/cache"
    - node_modules
    - "${TRAVIS_BUILD_DIR}/.plugin"
    - "${TRAVIS_BUILD_DIR}/.work/cache"

stages:
  - name: check
    if: branch = master and tag IS blank and type IN (pull_request, api, cron)
  - name: test
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: test trunk
    if: branch = master and tag IS blank and type IN (pull_request, api, cron)
  - name: prepare
    if: branch = master and tag IS blank and type IN (pull_request, api)
  - name: deploy
    if: tag IS present

before_script:
  - git clone --depth=1 https://github.com/wp-content-framework/travis-ci.git travis-ci
  - bash travis-ci/bin/prepare.sh

jobs:
  fast_finish: true
  include:
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpcs.sh
    - stage: check
      language: php
      php: '7.2'
      script: bash travis-ci/bin/php/phpmd.sh

    - stage: check
      language: node_js
      node_js: '11'
      dist: trusty
      script: bash travis-ci/bin/js/js-lint.sh


    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
        - ACTIVATE_POPULAR_PLUGINS=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.3'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env: WP_VERSION=latest
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.2'
      env:
        - WP_VERSION=5.2
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env: WP_VERSION=latest
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.1'
      env:
        - WP_VERSION=5.1
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=5.0
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '7.0'
      env:
        - WP_VERSION=latest
        - WP_MULTISITE=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=latest
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env:
        - WP_VERSION=5.0
        - WP_MULTISITE=1
        - COVERAGE_REPORT=1
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=4.9
      script: bash travis-ci/bin/php/wp-test.sh
    - stage: test
      language: php
      php: '5.6'
      env: WP_VERSION=3.9
      script: bash travis-ci/bin/php/wp-test.sh

    - stage: test
      language: node_js
      node_js: '10'
      dist: trusty
      script: bash travis-ci/bin/js/js-test.sh
    - stage: test
      language: node_js
      node_js: '11'
      dist: trusty
      env: COVERAGE_REPORT=1
      script: bash travis-ci/bin/js/js-test.sh


    - stage: test trunk
      language: php
      php: '7.3'
      env:
        - WP_VERSION=trunk
        - WP_MULTISITE=1
        - ACTIVATE_POPULAR_PLUGINS=1
      script: bash travis-ci/bin/php/wp-test.sh

    - stage: test trunk
      language: php
      php: '5.6'
      env: WP_VERSION=trunk
      script: bash travis-ci/bin/php/wp-test.sh


    - stage: prepare
      language: node_js
      node_js: '11'
      dist: trusty
      script:
        - source travis-ci/bin/deploy/env.sh
        - bash travis-ci/bin/deploy/wp-check-diff.sh


    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source travis-ci/bin/deploy/env.sh
        - bash travis-ci/bin/deploy/create.sh
      deploy:
        provider: releases
        skip_cleanup: true
        name: ${RELEASE_TITLE}
        tag_name: ${RELEASE_TAG}
        draft: true
        api_key:
          secure: hWItAWVS74UFW2WJoda+rK/mpm3YbUcQINJhs0SPc7TqGGAcqrn96mGAE6oARpwOcYHD844nEblVgOt45l4KkRKszgSIzuIJDMTEPHMstFlK5OymqdVzIkq5XpjhoQFqoaVPeYkaHAflOuPaUUOUY6mjV98m4bXiARhvHjQWBoBsiRcKqzUBT92ZAyn+arsokAT1+QOqRDqkqSgCqjLrUxNUXBrO4t22Y5wklxD1G/fw1jktdDDDtuIecG8UE0Byee15RPDyAda6R9hv7nIrN8d85+e+naYhKgbILMjoXiCdq0MeOroYH9tp5PQdBazSguYbkSOaWhO3OxZy5GR66mJEm0uHfeOtuaIjhBYqwDEzV4BGi9JCuHiitTUyEby5pIWIMYr3oHwRuWA5Zu9ZbhNbLxF5dfk1Mu/V15p/S+M7D1qPj0c3WrOpjAfzJdUlhsEMPH4KgVpMep+AX5UwxWzLM2/MD2EemKprYxjLWT13q4Nq0SROZ6Wl+2WemneoMC9QK8c4rLGg0Ocxb9LS5Hn+DCvS/LjMkjs5zmipycsJX2CTROxK+EggQrNDVkrE0MAo0cHCun8vTeahu9rGvg8tDAASWInnEe633nvws5SjYxwhcDVOC1gHiGKRKoR+KmBHVZ411978AEac4VFFZC4cCToW3foS1ayowSzn7oE=
        file: ${RELEASE_FILE}
        overwrite: true
        on:
          tags: true

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      script: skip
      before_deploy:
        - source travis-ci/bin/deploy/env.sh
      deploy:
        provider: script
        skip_cleanup: true
        script: bash travis-ci/bin/deploy/wp-release.sh
        on:
          tags: true

    - stage: deploy
      language: node_js
      node_js: '11'
      dist: trusty
      env:
        - GH_PAGES_PLUGIN_SCRIPT="./index.min.js"
        - GH_PAGES_PLUGIN_STYLE="./index.css"
        - GH_PAGES_TITLE="Hide Block Temporarily"
        - GH_PAGES_TEMPLATE=gutenberg
        - GH_PAGES_TRACKING_ID=UA-78163306-3
      script: skip
      before_deploy:
        - source tests/bin/deploy/env.sh
        - bash tests/bin/deploy/gh-pages.sh
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: ${GITHUB_TOKEN}
        keep_history: true
        local_dir: ${GH_PAGES_DIR}
        on:
          tags: true

  allow_failures:
    - env: WP_VERSION=4.9
    - env: WP_VERSION=3.9
